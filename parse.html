<!DOCTYPE html>
<html>
  <head>
    <meta charset="us-ascii">
  </head>

  <body>
    <canvas id="canvas" width="640" height="480">
    </canvas>

    <script type="text/javascript">
      var TWO_PI  = 2 * Math.PI,
          SQRT_GM = 0.017202098948448492

      function request(url, callback) {
        var req = new XMLHttpRequest()

        req.onreadystatechange = function() {
          if(req.readyState === 4)
            callback(
              req.status !== 0 && req.status !== 200 ?
                new Error("Received status " + req.status + " from server.") :
                undefined,
              req.responseText
            )
        }

        req.overrideMimeType("text/plain")
        req.open("GET", url)
        req.send()
      }

      function parse(data) {
        var rad   = Math.PI / 180,
            regex = /^.{6} (.{17}) (.{5}) (.{10}) (.{10}) (.{9}) (.{9}) (.{9}) (.{11}) (.{5})/gm,
            array = [],
            match, h

        if(regex.exec(data) && regex.exec(data))
          while(match = regex.exec(data)) {
            h = parseFloat(match[9])

            if(h <= 11)
              array.push(
                parseFloat(match[2]),
                parseFloat(match[3]),
                parseFloat(match[4]),
                parseFloat(match[5]) * rad,
                parseFloat(match[6]) * rad,
                parseFloat(match[7]) * rad,
                parseFloat(match[8]) * rad,
                h
              )
          }

        return array
      }

      function drawKepler(ctx, t, arr, offset) {
        /* FIXME: I think there's much simpler math available for computing a
         * given position than the transformation hell below. */

        var o  = arr[offset++],
            a  = arr[offset++],
            e  = arr[offset++],
            i  = arr[offset++],
            ci = Math.cos(i),
            w  = arr[offset++],
            sw = Math.sin(w),
            cw = Math.cos(w),
            l  = arr[offset++],
            sl = Math.sin(l),
            cl = Math.cos(l),
            m  = arr[offset++],
            h  = arr[offset++]

        t -= o
        m += t * SQRT_GM / Math.sqrt(a * a * a)
        o  = m
        o  = m + e * Math.sin(o)
        o  = m + e * Math.sin(o)

        var u = a * (Math.cos(o) - e),
            v = a * Math.sqrt(1 - e * e) * Math.sin(o),
            x = (cw * cl - sw * sl * ci) * u - (sw * cl + cw * sl * ci) * v,
            y = (cw * sl + sw * cl * ci) * u - (sw * sl - cw * cl * ci) * v

        ctx.beginPath()
        ctx.arc(x, -y, 0.03125 + Math.log(1 + (11 - h)) * 0.015625, 0, TWO_PI, true)
        ctx.fill()
      }

      function drawKeplerArray(ctx, t, arr) {
        var i = arr.length

        while(i) {
          i -= 8
          drawKepler(ctx, t, arr, i)
        }
      }

      request("orbital-elements.txt", function(err, data) {
        if(err)
          throw err

        data = parse(data)

        var canvas = document.getElementById("canvas"),
            ctx    = canvas.getContext("2d"),
            start  = Date.now()

        setInterval(function() {
          var t = 51544 + (Date.now() - start) * 0.001 * 365.25 / 12

          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)
          ctx.save()
          ctx.translate(ctx.canvas.width * 0.5, ctx.canvas.height * 0.5)
          ctx.scale(32, 32)
          ctx.lineWidth = 1 / 32
          drawKeplerArray(ctx, t, data)
          ctx.restore()
        }, 0)
      })
    </script>
  </body>
</html>

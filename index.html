<!DOCTYPE html>
<html>
  <head>
    <meta charset="us-ascii">
  </head>

  <body>
    <canvas id="canvas" width="640" height="480">
    </canvas>

    <script type="text/javascript">
      var SQRT_GM = 0.017202098948448492

      function Body(name, radius) {
        this.name   = name
        this.radius = radius
      }

      Body.prototype.draw = function(ctx) {
        ctx.beginPath()
        ctx.arc(0, 0, Math.log(this.radius) * 0.01, 0, 2 * Math.PI, true)
        ctx.fill()
      }

      function KeplerBody(name, radius, epoch, axis, eccentricity, inclination, argument, longitude, anomaly) {
        Body.call(this, name, radius)

        this.epoch        = epoch
        this.axis         = axis
        this.eccentricity = eccentricity
        this.inclination  = inclination
        this.argument     = argument
        this.longitude    = longitude
        this.anomaly      = anomaly
      }

      KeplerBody.prototype.__proto__ = Body.prototype

      KeplerBody.prototype.draw = function(ctx, t) {
        var m  = this.anomaly + (t - this.epoch) * SQRT_GM / Math.sqrt(this.axis * this.axis * this.axis),
            ci = Math.cos(this.inclination),
            sw = Math.sin(this.argument),
            cw = Math.cos(this.argument),
            sl = Math.sin(this.longitude),
            cl = Math.cos(this.longitude)

        t = m
        t = m + this.eccentricity * Math.sin(t)
        t = m + this.eccentricity * Math.sin(t)

        var u = this.axis * (Math.cos(t) - this.eccentricity),
            v = this.axis * Math.sqrt(1 - this.eccentricity * this.eccentricity) * Math.sin(t),
            x = (cw * cl - sw * sl * ci) * u - (sw * cl + cw * sl * ci) * v,
            y = (cw * sl + sw * cl * ci) * u - (sw * sl - cw * cl * ci) * v

        ctx.save()
        ctx.translate(x, -y)
        Body.prototype.draw.call(this, ctx)
        ctx.restore()
      }

      function request(url, callback) {
        var req = new XMLHttpRequest()

        req.onreadystatechange = function() {
          if(req.readyState === 4)
            callback(
              req.status !== 0 && req.status !== 200 ?
                new Error("Received status " + req.status + " from server.") :
                undefined,
              req.responseText
            )
        }

        req.overrideMimeType("text/plain")
        req.open("GET", url)
        req.send()
      }

      function parse(data) {
        var rad   = Math.PI / 180,
            regex = /^([^,]*),([^,]*)(?:,([^,]*),([^,]*),([^,]*),([^,]*),([^,]*),([^,]*),([^,]*))?$/gm,
            array = [],
            match

          while(match = regex.exec(data))
            if(match.length === 3)
              array.push(new Body(
                match[1],
                parseFloat(match[2])
              ))

            else if(match.length === 10)
              array.push(new KeplerBody(
                match[1],
                parseFloat(match[2]),
                parseFloat(match[3]),
                parseFloat(match[4]),
                parseFloat(match[5]),
                parseFloat(match[6]) * rad,
                parseFloat(match[7]) * rad,
                parseFloat(match[8]) * rad,
                parseFloat(match[9]) * rad
              ))

        return array
      }

      request("elements.csv", function(err, data) {
        if(err)
          throw err

        data = parse(data)

        var canvas = document.getElementById("canvas"),
            ctx    = canvas.getContext("2d"),
            start  = Date.now()

        setInterval(function() {
          var t = 51544 + (Date.now() - start) * 0.001 * 365.25 / 12,
              i = data.length

          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)
          ctx.save()
          ctx.translate(ctx.canvas.width * 0.5, ctx.canvas.height * 0.5)
          ctx.scale(32, 32)
          while(i--)
            data[i].draw(ctx, t)
          ctx.restore()
        }, 0)
      })
    </script>
  </body>
</html>

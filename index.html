<!DOCTYPE html>
<html>
  <head>
    <meta charset="us-ascii">
  </head>

  <body>
    <canvas id="canvas" width="640" height="480">
    </canvas>

    <script type="text/javascript">
      var TWO_PI  = 2 * Math.PI,
          SQRT_GM = 0.017202098948448492

      function request(url, callback) {
        var req = new XMLHttpRequest()

        req.onreadystatechange = function() {
          if(req.readyState === 4)
            callback(
              req.status !== 0 && req.status !== 200 ?
                new Error("Received status " + req.status + " from server.") :
                undefined,
              req.responseText
            )
        }

        req.overrideMimeType("text/plain")
        req.open("GET", url)
        req.send()
      }

      function parse(data) {
        var rad   = Math.PI / 180,
            regex = /^[^,]*,([^,]*),([^,]*),([^,]*),([^,]*),([^,]*),([^,]*),([^,]*),([^,]*)$/gm,
            array = [],
            match

          while(match = regex.exec(data))
            array.push(
              parseFloat(match[1]),
              parseFloat(match[2]),
              parseFloat(match[3]),
              parseFloat(match[4]),
              parseFloat(match[5]) * rad,
              parseFloat(match[6]) * rad,
              parseFloat(match[7]) * rad,
              parseFloat(match[8]) * rad
            )

        return array
      }

      function drawBody(ctx, x, y, r) {
        ctx.beginPath()
        ctx.arc(x, -y, Math.log(r) * 0.01, 0, TWO_PI, true)
        ctx.fill()
      }

      function drawKeplerBody(ctx, t, r, o, a, e, i, w, l, m) {
        var ci = Math.cos(i),
            sw = Math.sin(w),
            cw = Math.cos(w),
            sl = Math.sin(l),
            cl = Math.cos(l)

        t -= o
        m += t * SQRT_GM / Math.sqrt(a * a * a)
        o  = m
        o  = m + e * Math.sin(o)
        o  = m + e * Math.sin(o)

        var u = a * (Math.cos(o) - e),
            v = a * Math.sqrt(1 - e * e) * Math.sin(o),
            x = (cw * cl - sw * sl * ci) * u - (sw * cl + cw * sl * ci) * v,
            y = (cw * sl + sw * cl * ci) * u - (sw * sl - cw * cl * ci) * v

        drawBody(ctx, x, y, r)
      }

      function drawKeplerBodyArray(ctx, t, arr) {
        var i = arr.length

        while(i) {
          i -= 8
          drawKeplerBody(ctx, t, arr[i + 0], arr[i + 1], arr[i + 2], arr[i + 3], arr[i + 4], arr[i + 5], arr[i + 6], arr[i + 7])
        }
      }

      request("elements.csv", function(err, data) {
        if(err)
          throw err

        data = parse(data)

        var canvas = document.getElementById("canvas"),
            ctx    = canvas.getContext("2d"),
            start  = Date.now()

        setInterval(function() {
          var t = 51544 + (Date.now() - start) * 0.001 * 365.25 / 12

          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)
          ctx.save()
          ctx.translate(ctx.canvas.width * 0.5, ctx.canvas.height * 0.5)
          ctx.scale(32, 32)
          drawBody(ctx, 0, 0, 696342)
          drawKeplerBodyArray(ctx, t, data)
          ctx.restore()
        }, 0)
      })
    </script>
  </body>
</html>

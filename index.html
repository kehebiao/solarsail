<!DOCTYPE html>
<html>
  <head>
    <meta charset="us-ascii">
  </head>

  <body>
    <canvas id="canvas" width="640" height="480">
    </canvas>

    <script type="text/javascript">
      var TWO_PI  = 2 * Math.PI,
          SQRT_GM = 0.017202098948448492

      function request(url, callback) {
        var req = new XMLHttpRequest()

        req.onreadystatechange = function() {
          if(req.readyState === 4)
            callback(
              req.status !== 0 && req.status !== 200 ?
                new Error("Received status " + req.status + " from server.") :
                undefined,
              req.responseText
            )
        }

        req.overrideMimeType("text/plain")
        req.open("GET", url)
        req.send()
      }

      function parse(data) {
        var rad   = Math.PI / 180,
            regex = /^.{6} (.{17}) (.{5}) (.{10}) (.{10}) (.{9}) (.{9}) (.{9}) (.{11}) (.{5})/gm,
            array = [],
            match, h

        array.push(
          51544.5,
          0.38709927,
          0.20563593,
          7.00497902 * rad,
          (77.45779628 - 48.33076593) * rad,
          48.33076593 * rad,
          (252.25032350 - 77.45779628) * rad,
          2440
        )

        array.push(
          51544.5,
          0.72333566,
          0.00677672,
          3.39467605 * rad,
          (131.60246718 - 76.67984255) * rad,
          76.67984255 * rad,
          (181.97909950 - 131.60246718) * rad,
          6051.8
        )

        array.push(
          51544.5,
          1.00000261,
          0.01671123,
          -0.00001531 * rad,
          102.93768193 * rad,
          0,
          (100.46457166 - 102.93768193) * rad,
          6371.01
        )

        array.push(
          51544.5,
          1.52371034,
          0.09339410,
          1.84969142 * rad,
          (-23.94362959 - 49.55953891) * rad,
          49.55953891 * rad,
          (-4.55343205 - -23.94362959) * rad,
          3389.9
        )

        array.push(
          51544.5,
          5.20288700,
          0.04838624,
          1.30439695 * rad,
          (14.72847983 - 100.47390909) * rad,
          100.47390909 * rad,
          (34.39644051 - 14.72847983) * rad,
          69911
        )

        array.push(
          51544.5,
          9.53667594,
          0.05386179,
          2.48599187 * rad,
          (92.59887831 - 113.66242448) * rad,
          113.66242448 * rad,
          (49.95424423 - 92.59887831) * rad,
          58232
        )

        array.push(
          51544.5,
          19.18916464,
          0.04725744,
          0.77263783 * rad,
          (170.95427630 - 74.01692503) * rad,
          74.01692503 * rad,
          (313.23810451 - 170.95427630) * rad,
          25362
        )

        array.push(
          51544.5,
          30.06992276,
          0.00859048,
          1.77004347 * rad,
          (44.96476227 - 131.78422574) * rad,
          131.78422574 * rad,
          (-55.12002969 - 44.96476227) * rad,
          24622
        )

        if(regex.exec(data) && regex.exec(data))
          while(match = regex.exec(data)) {
            h = parseFloat(match[9])

            if(h <= 10)
              array.push(
                parseFloat(match[2]),
                parseFloat(match[3]),
                parseFloat(match[4]),
                parseFloat(match[5]) * rad,
                parseFloat(match[6]) * rad,
                parseFloat(match[7]) * rad,
                parseFloat(match[8]) * rad,
                1716 * Math.pow(10, -0.2 * h)
              )
          }

        return array
      }

      function drawKepler(ctx, t, arr, offset) {
        var o  = arr[offset++],
            a  = arr[offset++],
            e  = arr[offset++],
            i  = arr[offset++],
            ci = Math.cos(i),
            w  = arr[offset++],
            sw = Math.sin(w),
            cw = Math.cos(w),
            l  = arr[offset++],
            sl = Math.sin(l),
            cl = Math.cos(l),
            m  = arr[offset++],
            r  = arr[offset++]

        t -= o
        m += t * SQRT_GM / Math.sqrt(a * a * a)
        o  = m
        o  = m + e * Math.sin(o)
        o  = m + e * Math.sin(o)

        var u = a * (Math.cos(o) - e),
            v = a * Math.sqrt(1 - e * e) * Math.sin(o),
            x = (cw * cl - sw * sl * ci) * u - (sw * cl + cw * sl * ci) * v,
            y = (cw * sl + sw * cl * ci) * u - (sw * sl - cw * cl * ci) * v

        ctx.beginPath()
        ctx.arc(x, -y, Math.log(r) * 0.01, 0, TWO_PI, true)
        ctx.fill()
      }

      function drawKeplerArray(ctx, t, arr) {
        var i = arr.length

        while(i) {
          i -= 8
          drawKepler(ctx, t, arr, i)
        }
      }

      request("orbital-elements.txt", function(err, data) {
        if(err)
          throw err

        data = parse(data)

        var canvas = document.getElementById("canvas"),
            ctx    = canvas.getContext("2d"),
            start  = Date.now()

        setInterval(function() {
          var t = 51544 + (Date.now() - start) * 0.001 * 365.25 / 12

          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height)
          ctx.save()
          ctx.translate(ctx.canvas.width * 0.5, ctx.canvas.height * 0.5)
          ctx.scale(32, 32)
          /* FIXME: drawing the sun here is a hack */
          ctx.beginPath()
          ctx.arc(0, 0, Math.log(696342) * 0.01, 0, TWO_PI, true)
          ctx.fill()
          drawKeplerArray(ctx, t, data)
          ctx.restore()
        }, 0)
      })
    </script>
  </body>
</html>
